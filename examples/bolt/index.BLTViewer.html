<html>
<script type="text/javascript" charset="utf-8" src="//code.spark.autodesk.com/autodesk-spark-sdk.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
    <script src="./BLTLoader.js"></script>
    <script src="./BLTworker.js"></script>
    <!--<script src="./zlib.js"></script>
    <script src="./jpegimage.js"></script>-->

<!-- your config file and initialization -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/config.js"></script>
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/init.js"></script>


<script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>

<script type="text/javascript" charset="utf-8" src="../../plugins/login/login.js"></script>

<div class="logged-in-container">
<form>
 <input id="fileInput" type="file"/>
</form>

<pre id="log">
</pre>

</div>

    <script>

	    //First let's see if we have a valid access token
	    if (!ADSKSpark.Client.isAccessTokenValid()) {
			//user needs to login
		    //location.href = '../../plugins/login/login.html';
	    }

        //Draw Three.js viewer
        var meshes = [];

        var container = document.createElement( 'div' );
        $('.logged-in-container').append( container );

        var renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth * 0.9, window.innerHeight * 0.9 );
        container.appendChild( renderer.domElement );

        var camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.z = 100;

        var scene = new THREE.Scene();
	    // add subtle ambient lighting
	    var ambientLight = new THREE.AmbientLight(0x4f0f44);
	    scene.add(ambientLight);

	    // directional lighting
	    var directionalLight = new THREE.DirectionalLight(0xffffff);
	    directionalLight.position.set(1, 1, 1).normalize();
	    scene.add(directionalLight);

	    var lastObj;


        //After the .BLT decoder has converted the .BLT file into an bufferGeometry object
        var callBackRender = function (geometries) {

	        var material = new THREE.MeshLambertMaterial();

	        if(meshes){
		        for(var i=0;i<meshes.length;i++){
			        scene.remove(meshes[i] );
		        }
	        }

	        meshes=[];
	        for(var i=0;i<geometries.length;i++){
		        var mesh = new THREE.Mesh( geometries[i], material );
		        meshes.push(mesh);
		        scene.add(mesh);

	        }

        };



	    var loadingFile;

	    // LOADING - FILE
	    ADSKSpark.Files.downloadFile(17747882).
			    then(function (buffer){
				    //Download the .BLT file
				    loadingFile = buffer.arraybuffer.buffer
			    });


	    // FIRST - FILE
	    ADSKSpark.Files.downloadFile(17747813).
			    then(function (buffer){

				    var loader = new THREE.BLTLoader();

				    loader.load(buffer.arraybuffer.buffer, callBackRender);
			    });







	    //Upload File
        document.getElementById("fileInput").onchange = function () {
	        var loader = new THREE.BLTLoader();
	        loader.load(loadingFile, callBackRender);


	        // retrieve File from input
            var modelFile = this.files[0];
            var filename = this.files[0].name;

            //Package it for Drive API upload 
            var fileData = {
                file: modelFile
            };

            ADSKSpark.Files.uploadFile(fileData)
            .then(function (result){
                //Generate an image
                ADSKSpark.MeshAPI.importMesh(result.files[0].file_id, filename, true)
                .then(function (mesh){
                    ADSKSpark.Files.downloadFile(mesh.visual_file_id).
                    then(function (buffer){
                        //Download the .BLT file
                        loader.load(buffer.arraybuffer.buffer, callBackRender);
                    });
                });
            });

        };

        //Object rotates about the center. If it doesn't start on screen it may not show up
        var animate = function() {
            requestAnimationFrame( animate );

            if(meshes){
                // mesh.rotation.x += 0.005;
	            for(var i=0;i<meshes.length;i++){
		            meshes[i].rotation.y += 0.005;
		            meshes[i].rotation.x -= 0.005;
	            }


            }

            renderer.render( scene, camera );

        }
        animate();
    </script>

</html>
