<!DOCTYPE html>
<html lang="en">
<head>
	<title>Spark Sample Application</title>
	<meta charset="utf-8">

	<!-- fonts -->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>

	<!-- Bootstrap core CSS -->
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

	<!-- Common styles, also cloudfront-->
	<link href="../../../assets/css/common.css" rel="stylesheet">

	<style>
		#create-button {
			margin-top: -30px;
		}
	</style>

</head>

<body>
<div class="container">
	<div class="panel panel-default" id="assets">
		<div class="modal-header">
			<h4 class="modal-title">My Storage</h4>
			<a id="createSourceLink" href="../upload-source-to-asset/">
				<input class="btn btn-primary pull-right"
				       value="create source in asset"
				       id="create-button">
			</a>
		</div>
		<table class="table">
			<thead>
			<tr>
				<th>Name<br/><span>file_name</span></th>
				<th>ID<br/><span>file_id</span></th>
				<th>Size<br/><span>size</span></th>
				<th>Download link<br/><span>_link</span></th>
				<th>Actions</th>
			</tr>
			</thead>
			<tbody id="assetsTbody">

			</tbody>
		</table>
	</div>

</div>
<!-- /container -->

<script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>

<!-- your config file -->
<script type="text/javascript" charset="utf-8" src="../../../assets/scripts/config.js"></script>

<!-- spark sdk -->
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/spark-config.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/utilities.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/spark-auth.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/spark-drive.js"></script>

<!-- end spark sdk -->
<!--<script type="text/javascript" charset="utf-8" src="//spark-dev-portal-stg.s3.amazonaws.com/sdk/spark-sdk-latest.min.js"></script>
should be cloudfront!
-->


<script>

	//the asset id we are referring to
	var currentAssetId;

	/**
	 * Retrieve asset sources and set them in a table
	 */
	function retrieveAssetSourcesAndSetInDOM(){
		//Get my assets and append to table in DOM
		spark.drive.retrieveAssetSources(currentAssetId,function (response) {
			console.info('response after sources for asset ' + currentAssetId + ':',response);
			$('#assetsTbody').empty();
			var sources = response.sources;

			if (sources.length) {
				$.each(sources, function (index, item) {
					var tr = $('<tr class="source-in-table"></tr>');
					tr.append($('<td>' + item.file_name + '</td>'));
					tr.append($('<td>' + item.file_id + '</td>'));
					tr.append($('<td>' + item.size + '</td>'));
					tr.append($('<td>' + item._link + '</td>'));
					tr.append($('<td><a onclick="deleteSourceFromAsset(' + currentAssetId + ',' + item.file_id + ',$(this).parents(\'tr\'))">' +
					'<i class="glyphicon glyphicon-remove delete"></i></a></td>'));
					$('#assetsTbody').append(tr);

				});
			} else {
				var tr = $("<tr class='asset-in-table'></tr>")
				var nameTd = $('<td colspan="4">This asset doesn\'t have sources yet.  ' +
				'<a href="../upload-source-to-asset/?assetId=' + currentAssetId + '">Create source in this asset now</a></td>');
				tr.append(nameTd);
				$("#assetsTbody").append(tr);
			}
		});

	}


	/**
	 * Deletes a source in an asset
	 */
	function deleteSourceFromAsset(assetId,fileId,assetElem){
		var c = confirm('Are you sure you want to delete?');

		if (c){
			spark.drive.deleteAssetSources(assetId, fileId, function () {
				assetElem.remove();
			});
		}
	}

	/**
	 * Run when DOM is ready.
	 * The spark object already exists in this point
	 */
	jQuery(function ($) {

		//First let's see if we have a valid access token
		if (!spark.auth.isAccessTokenValid()) {
			window.location.href = '../../auth/';
		}else {
			//Assume we provided assetId in URL
			var urlParams = spark.util.extractParamsFromURL();
			currentAssetId = urlParams['assetId'] ? urlParams['assetId'] : 0;

			if (!currentAssetId) {
				$('#manageAsset').html('This example requires a valid asset ID that is passed as a parameter "assetId" through the URL');
			} else {
				retrieveAssetSourcesAndSetInDOM();

				//set up the correct link to create new source in asset
				$('#createSourceLink').attr('href', '../upload-source-to-asset/?assetId=' + currentAssetId);
			}
		}
	});

</script>

</body>
</html>
