<!DOCTYPE html>
<html lang="en">
<head>
	<title>Spark Sample Application</title>
	<meta charset="utf-8">

	<!-- Bootstrap core CSS -->
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

	<!-- Common styles, also cloudfront-->
	<link href="../../../assets/css/common.css" rel="stylesheet">

	<style>

	</style>

</head>

<body>
<div class="container">
	<div id="manageAsset">
		<div class="modal-header">
			<h4 class="modal-title" id="manageTitle">Upload file and add to asset</h4>
		</div>
		<div class="modal-body">
			<form id="file-form">
				<div class="form-group">
					<label for="fileData">File to upload</label>
					<input type="file" id="fileData" placeholder="file data" class="field" required>
				</div>

				<div class="form-group">
					<label>Caption</label>
					<input type="text"
					       class="form-control field"
					       placeholder="Title"
					       name="caption"
					       required>
				</div>
				<div class="form-group">
					<label>Description</label>
					<textarea class="form-control field"
					          name="description"
					          placeholder="Description"
					          required></textarea>
				</div>

				<div class="form-group">

					<label>Is primary?</label>
					<br/>
					<div class="col-md-1">
						false<input type="radio"
						            class="form-control field"
						            name="is_primary"
						            checked
						            value="false">
					</div>
					<div class="col-md-1">
						true<input type="radio"
						           class="form-control field"
						           name="is_primary"
						           value="true">
					</div>
				</div>
				<div class="modal-footer">
					<a href="../show-my-assets">
						<input class="btn btn-primary" value="cancel" id="manage-assets-cancel">
					</a>

					<input class="btn btn-primary" type="submit" value="Send">

				</div>
			</form>
		</div>

	</div>
</div>
<!-- /container -->

<script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>

<!-- your config file -->
<script type="text/javascript" charset="utf-8" src="../../../assets/scripts/config.js"></script>

<!-- spark sdk -->
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/spark-config.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/utilities.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/spark-auth.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../vendor/spark/spark-drive.js"></script>

<!-- end spark sdk -->
<!--<script type="text/javascript" charset="utf-8" src="//spark-dev-portal-stg.s3.amazonaws.com/sdk/spark-sdk-latest.min.js"></script>
should be cloudfront!
-->


<script>

	var currentAssetId, //the asset id we are referring to
			fileData //the file data
			;

	/**
	 * Get the file data and set listener on form submit
	 * to upload the file
	 */

	function setUpUploadFileFlow(){
		//get the file data
		$('#fileData').on('change', function () {
			fileData = this.files[0];
		});

		//catch the form submit
		$('#file-form').on('submit', function (e) {
			e.preventDefault();

			var sourceFile = {
				filePublicStatus: $('input[name=file-public-status]:checked').val(),
				fileData: fileData
			};

			var thumbnail = {
				caption: $('input[name=caption]').val(),
				description: $('textarea[name=description]').val(),
				is_primary: $('input[name=is_primary]:checked').val(),
			}


			//upload the file to spark drive
			spark.drive.uploadFile(sourceFile, function (response) {
				console.info('upload file response:', response);
				if (response.files && response.files.length > 0) {
					var successTextWrapper = $('<div id="success-text"></div>');
					var fileName = response.files[0].name;
					var successText = 'File <b>' + fileName + ' </b>uploaded successfully';
					successText += '<br>File id is <b>' + response.files[0].file_id + '</b>';

					if (response.files[0].public_url.length) {
						successText += '<br>File public url is <b>' + response.files[0].public_url + '</b>';
					}

					successText += '<br/></br/><span id="loading">Adding thumbnail to asset...</span>';

					successTextWrapper.html(successText);

					$('#file-form').html(successTextWrapper);

					thumbnail.id = response.files[0].file_id;

					console.log(thumbnail);


					spark.drive.createAssetThumbnail(currentAssetId,[thumbnail], function(response){
						console.info('response from add thumbnail to file:', response);
						$('#loading').remove();
						var successText = 'the thumbnail <b>' + fileName + '</b> has been added to asset <b>' + currentAssetId + '</b>';
						$('#success-text').append(successText);
					});

				}


			});

		});
	}


	/**
	 * Run when DOM is ready.
	 * The spark object already exists in this point
	 */
	jQuery(function ($) {

		//First let's see if we have a valid access token
		if (!spark.auth.isAccessTokenValid()) {
			window.location.href = '../../auth/';
		}else {
			//Assume we provided assetId in URL
			var urlParams = spark.util.extractParamsFromURL();
			currentAssetId = urlParams['assetId'] ? urlParams['assetId'] : 0;

			if (!currentAssetId) {
				$('#manageAsset').html('This example requires a valid asset ID that is passed as a parameter "assetId" through the URL');
			} else {
				setUpUploadFileFlow();
			}
		}

	});

</script>

</body>
</html>