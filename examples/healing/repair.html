<!DOCTYPE html>
<html lang="en">
<head>
	<title>Spark Sample Application - Upload Source File</title>
	<meta charset="utf-8">

	<!-- fonts -->
	<link href='//fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>

	<!-- Bootstrap core CSS -->
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

	<!-- Common styles -->
	<link href="../../assets/css/common.css" rel="stylesheet">

	<style>

		.modal-header {
			position: relative;
			padding: 10px 20px;
		}

		.modal-header .layouts {
			position: absolute;
			right: 0;
			background-color: #ffffff;
			padding-left: 10px;
			top:9px;
		}

		.modal-header .layouts a {
			border-right: 1px solid lightgrey;
			margin-right: 6px;
			padding: 4px 10px 0 0;
		}

		#empty-assets {
			background-color: #F8F8F8;
			text-align: center;
		}

		#empty-assets p {
			padding: 20px 0;
			color: darkgray;
		}

		#empty-assets a {
			margin: 20px 0;
		}

		.img {
			width: 100%;
		}

		.dropdown i {
			cursor: pointer;
			position: absolute;
			left: -20px;
		}

		#assets{
			margin-top:-14px;
		}

		.problems-container{
			margin-top: 60px;
			overflow-y: scroll;
			height: 370px;
		}


		.notification-bar{
			/**position: relative;*/
			display: none;
		}
		/**

		.notification-bar {
			font-size: 14px;
			padding: 8px;
			background: rgb(254, 250, 230);
			text-align: center;
			border-bottom: 1px solid rgb(235, 234, 231);
			position: relative;
			top: -47px;
			margin-bottom: -41px;
		}

		.notification-bar.fixed {
			display: none;
			position: fixed;
			width: 100%;
			top: 86px;
			z-index: 5;
		}

		.notification-bar .notification_icon {
			margin-right: 5px;
			vertical-align: bottom;
		}

		.si-status-ok-large {
			background-position: -281px -126px;
			width: 25px;
			height: 25px;
		}


		.notification-bar {
			font-size: 14px;
			padding: 8px;
			background: #fefae6;
			text-align: center;
			border-bottom: 1px solid #ebeae7;
			position: relative;
			top: -47px;
			margin-bottom: -41px;
		}*/

	</style>

</head>

<body>
<div class="container">
	<div class="spinner-with-text">
		<div id="spinner-text"></div>
		<div class="spinner"></div>
	</div>

	<div id="messageSuccess" class="notification-bar fixed saved-notification ng-scope">
		<i class="notification_icon spark_icon si-status-ok"></i><span></span></div>

	<div id="messageError" class="notification-bar fixed">
		<i class="notification_icon spark_icon si-status-error"></i>
		Error!
	</div>

	<div class="hidden" id="problems-table">
		<div class="problems-container" id="problems-container">
			<table class="table">
				<thead>
				<tr>
					<th>Issues<br/></th>
					<th>Found<br/></th>
					<th>Repaired<br/></th>
				</tr>
				</thead>
				<tbody id="problemsTbody" >

				</tbody>
			</table>
		</div>
	</div>

	<div style="margin: 0 auto;width: 25%;">
		<div id="downloadMesh" class="btn spark_btn primary post-upload hidden" >Download</div>
	</div>

	<!--<a class="btn spark_btn primary" href="#" id="downloadMesh" onclick="eventBroadCaster.broadcastEvent('manageIframe.loggedIn',{forceRedirect:true})">Download</a>
-->
</div>
<!-- /container -->

<script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/bower_components/promise-polyfill/Promise.min.js"></script>

<!-- common scripts -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/common.js"></script>

<!-- spark sdk -->
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/config/Constants.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/utilities/Helpers.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/utilities/Request.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/Client.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Members.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Assets.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Files.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/Tasks.js"></script>

<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/MeshAPI.js"></script>


<!-- OR use the minified version
<script type="text/javascript" charset="utf-8" src="//spark-dev-portal-stg.s3.amazonaws.com/sdk/autodesk-spark-sdk-latest.min.js"></script>
-->
<!-- your config file and initialization -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/config.js"></script>
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/init.js"></script>

<!-- Enable broadcasting events and logging requests to top window -->
<script type="text/javascript" charset="utf-8" src="../../plugins/broadcaster/eventBroadcaster.js"></script>
<script type="text/javascript" charset="utf-8" src="../../plugins/ajaxlogger/ajaxCallListener.js"></script>


<script>



/**
 * Run when DOM is ready.
 * The spark object already exists in this point
 */
jQuery(function ($) {

	var problemsNamesArray = {
		holes:"Holes",
		degenerate_triangles:"Degenerate Triangles",
		duplicate_triangles:"Duplicate Trinagles",
		nonmanifold_vertices:"Nonmanifold Triangles",
		inconsistently_oriented_triangles:"Inconsistently Oriented Triangles"
	};

	eventBroadCaster.broadcastEvent('repairIframe.analyze');

	//First let's see if we have a valid access token
	if (!ADSKSpark.Client.isAccessTokenValid()) {
		location.href = '../../../plugins/login/login.html';
	} else {
		//Assume we provided assetId in URL
		var urlParams = ADSKSpark.Helpers.extractParamsFromURL();
		var meshId = urlParams['meshId'] ? urlParams['meshId'] : 0;

		//var importResponse = ADSKSpark.MeshAPI.importMesh(fileId,fileName);

		debugger;
		if(meshId!=0) {
			$('.spinner-with-text').show();
			$('.spinner').show();
			$("#spinner-text").text("Analyzing...");

			ADSKSpark.MeshAPI.analyzeMesh(meshId).then(function (payloadAnalyze) {
				$("#spinner-text").text("Repairing...");

				console.log(payloadAnalyze);
				eventBroadCaster.broadcastEvent('repairIframe.repair');

				var analyzedProblems = payloadAnalyze.problems;
				if(analyzedProblems.length==0){
					$("#messageSuccess > span").text("Your model doesn't need a repair.");
					$("#messageSuccess").show();
					$('.spinner-with-text').hide();

					return;
				}
				var problemsArray = {};
				for (var i = 0; i < analyzedProblems.length; i++) {
					problemsArray[analyzedProblems[i].type] = true;
				}

				ADSKSpark.MeshAPI.repairMesh(meshId).then(function (payloadRepair) {
					console.log(payloadRepair);
					eventBroadCaster.broadcastEvent('repairIframe.repaired');
					var problemsAfterRepair = payloadRepair.problems;

					for (var i = 0; i < problemsAfterRepair.length; i++) {
						problemsArray[problemsAfterRepair[i].type] = false;
					}

					console.log(problemsArray);

					$('.spinner-with-text').hide();
					$('#problems-table').removeClass('hidden');
					$('#downloadMesh').removeClass('hidden');

					var problemsLeft = 0;

					$.each(problemsNamesArray, function (index, item) {
						var tr = $('<tr class="in-table"></tr>')
						//var nameTd = $('<td><i class="spark_icon si-asset-icon"></i>' + item.asset_name + '</td>');
						tr.append($('<td>' + item + '</td>'));

						debugger;

						if(problemsArray[index]!=undefined){

							tr.append($('<td>' +"Yes" + '</td>'));

							if(problemsArray[index]==true){
								tr.append($('<td>' +  "Yes"  + '</td>'));
							}
							else{
								tr.append($('<td>' +  "No"  + '</td>'));
								problemsLeft += 1;
							}
						}
						else{
							tr.append($('<td>' + "-" + '</td>'));
							tr.append($('<td>' + "-" + '</td>'));

						}

						$('#problemsTbody').append(tr);

					});

					var successMessage = "";

					if(problemsLeft>0){
						successMessage = "There are still some problems.";
					}
					else{
						successMessage = "File successfully repaired";
					}

					$("#messageSuccess > span").text(successMessage);
					$("#messageSuccess").show();

					var newMeshId = payloadRepair.id
					$("#downloadMesh").on("click", (function(){
						exportAndDownload(newMeshId)
					}));

				});
			})
		}

	}

	var exportAndDownload = function(newMeshId){

		ADSKSpark.MeshAPI.exportMesh(newMeshId).then(function (payloadExport) {
			console.log(payloadExport);
			var fileId = payloadExport.file_id;
			ADSKSpark.Files.downloadFileByURL(fileId).then(function (downloadPayload){
				console.log(downloadPayload);
				var downloadUrl = downloadPayload.download_url;
				window.location.href = downloadUrl;
			});
		});
	};

});

</script>

</body>
</html>