<!DOCTYPE html>
<html lang="en">
<head>
	<title>Spark Sample Application - Upload Source File</title>
	<meta charset="utf-8">

	<!-- fonts -->
	<link href='//fonts.googleapis.com/css?family=Open+Sans:300,600,400' rel='stylesheet' type='text/css'>

	<!-- Bootstrap core CSS -->
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

	<!-- Common styles -->
	<link href="../../assets/css/common.css" rel="stylesheet">

	<style>

		#upload-wrapper {
			position: relative;
		}

		#file-input.hidden-upload {
			height: 25px;
			width: 50px;
			left:345px;
			position: absolute;
			top: 140px;
			cursor: pointer;
			opacity: 0.0;
		}

		#dropzone {
			display: none;
			height: 200px;
			text-align: center;
			border: 2px dashed #e5e5e5;
			border-radius: 4px;
		}

		#dropzone h4{
			font-size: 16px;
		}

		#file-upload-result,#file-upload-error{
			display: none;
			height: 50px;
			text-align: center;
		}
		#file-upload-error{
			height:30px;
		}

		#dropzone.drag-active {
			border: 2px dashed #000000;
			opacity: 0.3;
		}

		#upload-icon {
			margin-top: 26px;
			margin-bottom: 5px;
		}



		#file-upload-text-res{
			font-weight: bold;
			margin-top:70px;
		}
		.si-status-ok{
			margin-right: 10px;
		}

		.uploaded-filename{
			font-size: 16px;
			margin: auto;
			width: 350px;
		}

		.uploaded-filename b{
			font-weight: 600;
		}

		#file-upload-text{
			margin-top: 20px;
			color:#555555;
		}
		#file-upload-text p{
			display: none;
		}

		.healing-header{
			padding-bottom: 53px;
			border-bottom: 0px;
		}

		#dropzone {
			cursor: pointer;
		}

		.notification-bar{
			display: none;
		}

	</style>

</head>

<body>
<div class="container">

	<div class="spinner-with-text">
		<div id="spinner-text"></div>
		<div class="spinner"></div>
	</div>

	<div id="messageError" class="notification-bar fixed">
		<i class="notification_icon spark_icon si-notification-error"></i>
		<span>We apologise but there seems to be temporary problem with the service.</span>
	</div>

	<div id="uploadFile">
		<div class="modal-header healing-header">
			Improve your 3D printing results: Upload your 3D model and this tool will locate and heal flaws that affect 3D printing.
			Supports OBJ and STL 3D objects.
		</div>
		<div class="modal-body" id="upload-wrapper">
			<div id="file-upload-error">
				<div class="notification-bar">
					<i class="spark_icon"></i> File size exceeds the allowed value
				</div>
			</div>
			<div id="file-upload-result">
				<div class="notification-bar">
					<i class="spark_icon si-status-ok"></i> File successfuly uploaded
				</div>
				<div id="file-upload-text-res"></div>
				<p>file ID: <span id="file-id"></span>
					<i class="spark_icon si-help with_hover"></i>
					<i class="stooltip"><span>The ID of the file</span></i>
				</p>
			</div>

			<div id="dropzone" class="post-upload">
				<div id="upload-icon" class="spark_icon si-upload-icon"></div>
				<h4 id="file-name" class="post-upload">Upload OBJ/STL File</h4>

				<div id="file-upload-text">
					<span>Drop a file</span> or <a id="browse-file">Browse</a>
					<p>Maximum file size of <b></b></p>
				</div>
			</div>


			<form id="file-form" novalidate="">
				<section class="form_field post-upload" id="file-input-section">
					<input type="file" id="file-input" placeholder="file data" class="field hidden-upload" style="display: none" required>
				</section>

				<div class="form-footer">
					<div class="publish-wrapper post-upload">
						<input type="checkbox" id="isQuick">
						<label for="isQuick"><span class="chk"></span>Quick Mode</label>
					</div>

				</div>

			</form>
		</div>
	</div>

</div>
<!-- /container -->

<script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/bower_components/promise-polyfill/Promise.min.js"></script>

<!-- common scripts -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/common.js"></script>

<!-- spark sdk -->
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/config/Constants.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/utilities/Helpers.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/utilities/Request.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/Client.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Members.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Assets.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Files.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/Tasks.js"></script>

<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/MeshAPI.js"></script>


<!-- OR use the minified version
<script type="text/javascript" charset="utf-8" src="//spark-dev-portal-stg.s3.amazonaws.com/sdk/autodesk-spark-sdk-0.1.0.min.js"></script>
-->
<!-- your config file and initialization -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/config.js"></script>
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/init.js"></script>

<!-- Enable broadcasting events and logging requests to top window -->
<script type="text/javascript" charset="utf-8" src="../../plugins/broadcaster/eventBroadcaster.js"></script>
<script type="text/javascript" charset="utf-8" src="../../plugins/ajaxlogger/ajaxCallListener.js"></script>


<script>

	//log http requests
	//ajaxCallListenerFromIframe();


	var fileData;

	var allowedFileUploadSize = 1000 * 1000 * 100; //100MB

	/**
	 * What happens when user selects file
	 */
	function handleFileDrop(file) {
		fileData = file;
		if (fileData.size <= allowedFileUploadSize) {
			$('#file-name').html('<p class="uploaded-filename"><b>' + fileData.name + '</b> is waiting for upload</p>');
			$('.submit-wrapper .spark_btn.primary').removeAttr('disabled');
			$('#file-upload-text').hide();
			upload();
		}else{
			$('#file-upload-error').show();
			setTimeout(function(){
				$('#file-upload-error').hide();
			},3000);
		}
	}

	function upload() {
		//nice UI
		$('.spinner-with-text').show();
		$('.spinner').show();
		$("#spinner-text").text("Loading...");

		$('#uploadFile').hide();
		//$('.submit-wrapper .spark_btn.primary').attr('disabled', 'disabled');

		//e.preventDefault();

		//var sourceFile = {
		//	file: fileData
		//};


		ADSKSpark.MeshAPI.uploadFile(fileData).then(function(result) {
			var upload = result.files[0];
			var isQuick = $("#isQuick").is(':checked');

			$("#spinner-text").text("Importing...");


			ADSKSpark.MeshAPI.importMesh(upload.file_id, upload.name, true, null, undefined).then(

					function(mesh) {
						var meshId = mesh.id;
						window.location.href="repair.html?meshId=" + meshId + "&isQuick="+isQuick;

					},function(error){
						console.log(error);
						$("#messageError").show();
					});

		},function(error){
			console.log(error);
			$("#messageError").show();
		});
	}


	/**
	 * Provide file upload UI
	 * Attempt to use HTML5 file APIs to provide a nicer UI for file upload
	 */
	function setFileUploadUI() {

		$("#dropzone").on('click', function(){$('#file-input').click();})
		//set allowed file size
		var fileSizeHumanReadable = allowedFileUploadSize.fileSize(1);
		$('#file-upload-text p').show().find('b').text(fileSizeHumanReadable);

		//make sure the upload form button is initially disabled
		$('.submit-wrapper .spark_btn.primary').attr('disabled', 'disabled');

		//handle file select
		$('#file-input').on('change', function () {
			handleFileDrop(this.files[0]);
		});

		// Check for the various File API support.
		if (window.File && window.FileReader && window.FileList && window.Blob) {
			// Great success! All the File APIs are supported.
			//upload();
			//setup dropzone functionality
			var $dropzone = $('#dropzone');
			$dropzone.show();

			$dropzone.on('dragover', function (e) {
				e.stopPropagation();
				e.preventDefault();
				e.originalEvent.dataTransfer.dropEffect = 'copy';
				$(this).addClass('drag-active');
			});

			$dropzone.on('dragleave', function (e) {
				e.stopPropagation();
				e.preventDefault();
				$(this).removeClass('drag-active');
			});


			$dropzone.on('drop', function (e) {
				$(this).removeClass('drag-active');
				e.stopPropagation();
				e.preventDefault();
				var files = e.originalEvent.dataTransfer.files;
				handleFileDrop(files[0]);
			});


		} else {
			$('#file-input').removeClass('hidden-upload');
		}
	}




	/**
	 * Run when DOM is ready.
	 * The spark object already exists in this point
	 */
	jQuery(function ($) {

		//First let's see if we have a valid access token
		if (!ADSKSpark.Client.isAccessTokenValid()) {
			location.href = '../../../plugins/login/login.html';
		} else {
			//Assume we provided assetId in URL
			var urlParams = ADSKSpark.Helpers.extractParamsFromURL();


				setFileUploadUI();
				//setUpUploadFileFlow();
				common.setUIFunctionality();


		}


	});

</script>

</body>
</html>