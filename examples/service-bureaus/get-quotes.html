<!DOCTYPE html>
<html lang="en">
<head>
	<title>Spark Sample Application - Show My Assets - list view</title>
	<meta charset="utf-8">

	<!-- Bootstrap core CSS -->
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

	<!-- Common styles -->
	<link href="../../assets/css/common.css" rel="stylesheet">

<style>

	#materials-select{
		height: 44px;
		width:200px;
	}

	canvas{
		width:300px !important;
		height: 200px !important;
	}

	.quote{
		background-color: #f9f8f8;
		border-radius: 6px;
		padding: 10px;
		margin-bottom: 10px;
		min-height: 65px;
	}

	.quote span{
		float:right;
		margin-top: 13px;
		margin-right: 20px;
		font-size:18px;
	}
	.quote img{
		margin-left: 20px;
	}
	.quote a{
		margin-right: 20px;
		margin-top: 4px;


	}


	.quote .spinner{
		display: none;
		border-top-color: white;
		margin-right: 96px;
	}

	.quote-btn-container{
		float: right;
		position: relative;
		display: inline;
	}

	#quotes-container{
	    overflow-y: auto;
        height: 158px;
	}


	.quotes-spinner .spinner {
		display: none;
		margin-top: 300px;
	}

	.no-results{
		text-align: center;
		margin-top: 54px;
		font-size: 24px;
		color: silver;
	}
</style>
</head>

<body>

<div class="container">
	<div class="modal-header">
		<h4 class="modal-title">GET QUOTES</h4>
	</div>
	<div class="modal-body">
		<form id="get-quotes-form" class="sample-app-form" novalidate="">
			<section class="form_field pull-left">
				<label for="materials-select">
					Select a material <span class="field-label">&nbsp;/&nbsp;material_id</span><i class="required"></i>
					<i class="spark_icon si-help with_hover"></i>
					<i class="stooltip"><span style="display: none;">Choose a material from the list.</span></i>
				</label>
				<select class="form-control" id="materials-select" required="required">
					<option value="">Please select...</option>
				</select>
				<div class="field_error hidden">
					<span>Required</span>
				</div>
			</section>
			<div id="canvas-container" class="pull-right"></div>
			<div class="spacer clearfix"></div>
			<div class="quotes-spinner"><div class="spinner"></div></div>
			<section class="form_field">
				<div id="quotes-container"></div>
			</section>
	    </form>
	</div>
</div>


<script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script type="text/javascript" charset="utf-8"
        src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<!-- spark sdk -->
<!--<script type="text/javascript" charset="utf-8" src="//code.spark.autodesk.com/autodesk-spark-sdk.min.js"></script>-->
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/config/Constants.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/utilities/Helpers.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/utilities/Request.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/Client.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Members.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Assets.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/drive/Files.js"></script>
<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/service-bureaus/ServiceBureaus.js"></script>

<!-- common scripts -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/common.js"></script>

<!-- your config file and initialization -->
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/config.js"></script>
<script type="text/javascript" charset="utf-8" src="../../assets/scripts/init.js"></script>

<!-- Enable broadcasting events and logging requests to top window -->
<script type="text/javascript" charset="utf-8" src="../../plugins/broadcaster/eventBroadcaster.js"></script>
<script type="text/javascript" charset="utf-8" src="../../plugins/ajaxlogger/ajaxCallListener.js"></script>

<script type="text/javascript" charset="utf-8" src="../../vendor/spark-js-sdk/sdk/src/service-bureaus/ServiceBureaus.js"></script>
<script>

	var currentFileId, serviceBureaus, materials;

	var getServiceBureaus = function(){

		ADSKSpark.ServiceBureaus.getServiceBureaus().then(function (response) {
		 console.info('get service bureaus response:', response);
		 if (response.length > 0) {
			 serviceBureaus = response;
		 }
		 });
		//return JSON.parse('[{"id":"59fe3fa2-05f0-4d13-a0f1-981fe840d8e0","name":"i.materialise","logoUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/59fe3fa2-05f0-4d13-a0f1-981fe840d8e0/logourl/imaterialise_logo.png","websiteUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/59fe3fa2-05f0-4d13-a0f1-981fe840d8e0/websiteurl"},{"id":"60cc25c8-a922-4102-a640-af534051a71e","name":"shapeways","logoUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/60cc25c8-a922-4102-a640-af534051a71e/logourl/shapeways_logo.png","websiteUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/60cc25c8-a922-4102-a640-af534051a71e/websiteurl"},{"id":"c04e968b-146b-4856-aea8-3cc1a137970c","name":"sculpteo","logoUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/c04e968b-146b-4856-aea8-3cc1a137970c/logourl/sculpteo_logo.png","websiteUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/c04e968b-146b-4856-aea8-3cc1a137970c/websiteurl"},{"id":"ea0036eb-43da-4495-ae1b-3fff63e92db7","name":"3dhubs","logoUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/ea0036eb-43da-4495-ae1b-3fff63e92db7/logourl/3dhubs_logo.png","websiteUrl":"https://sandbox.spark.autodesk.com/api/v1/servicebureaus/ea0036eb-43da-4495-ae1b-3fff63e92db7/websiteurl"}]');
	}

	var getSparkMaterials = function(){


		/*ADSKSpark.Files.getFileDetails(currentFileId).then(function (response) {
			console.info('upload file response:', response);
			if (response.length > 0) {
				console.log(response);
			}
		});*/


		ADSKSpark.ServiceBureaus.getSparkMaterials().then(function (response) {
			console.info('getSparkMaterials response:', response);
			if (response.length > 0) {
				materials = response;
				for(var i in materials){
					if(materials[i].name != undefined) {
						$("<option value='" + materials[i].id + "'>" + materials[i].name + "</option>").appendTo("#materials-select");
					}
				}

			}
		});
		//return JSON.parse('[{"id": "03C61213-4EEA-4352-A6F3-FD1E1461F137","name": "Gold"},{"id": "49108D1B-0AFC-4417-ABB0-538FC6CA7F6F","name": "Rhodium"},{"id": "6759E5F8-A896-4695-BB11-5B9D604A9E06","name": "Alumide"},{"id": "8C64A3EE-9D41-4925-9EF4-81A359B5D0E6","name": "Polyamide"},{"id": "929D4AB5-1178-4639-9F2E-F3AA3ECD196E","name": "Sandstone"},{"id": "95C93D92-7C95-44F4-888A-C1A06EA20A29","name": "Resin"},{"id": "A8585DB8-294E-4FF3-A5EF-7E66734E5789","name": "Steel"},{"id": "F7CB79CD-B857-486C-82FE-BE737A4810B5","name": "Ceramics"},{"id": "FC565E34-8144-4209-B110-0F4745AC07C6","name": "Aluminum"}]');

	}

	var getQuotes = function(selectedMaterialId, fileId) {

		$("#quotes-container").empty();
		$(".quotes-spinner .spinner").show();

		var data = JSON.stringify({ 'items': [ {'material_id': selectedMaterialId,'files': [{"file_id":fileId}]}] });

		ADSKSpark.ServiceBureaus.getQuotes(data).then(function (response) {
		 console.info('get quotes response:', response);

			$(".quotes-spinner .spinner").hide();
			 var quotes = response.quotes;

			 var exist = false;
			 if (quotes != null) {
				 for (var i in quotes) {

					 if (quotes[i].success) {
						 exist = true;
						 var logoUrl = getServiceBureauLogoUrlById(quotes[i].service_bureau_id);
						 $("<div class='quote'><img src='" + logoUrl + "'/><div class='quote-btn-container'><div class='spinner'></div><a data-service-bureau-id='" + quotes[i].service_bureau_id + "' class='print_btn spark_btn primary pull-right'>Print</a></div><span>$" + quotes[i].price + "</span></div>").appendTo("#quotes-container");
					 }
				 }
			 }

			if(exist == false){
				$("<div class='no-results'>No results found</div>").appendTo("#quotes-container");
			}
		 });

         /*var response = JSON.parse('{"success":true,"quotes":[{"success":true,"service_bureau_id":"59fe3fa2-05f0-4d13-a0f1-981fe840d8e0","material_id":"6759E5F8-A896-4695-BB11-5B9D604A9E06","file_id":"17377619","price":"16.82"},{"success":true,"service_bureau_id":"60cc25c8-a922-4102-a640-af534051a71e","material_id":"6759E5F8-A896-4695-BB11-5B9D604A9E06","file_id":"17377619","price":"12.47"},{"success":false,"service_bureau_id":"c04e968b-146b-4856-aea8-3cc1a137970c","material_id":"6759E5F8-A896-4695-BB11-5B9D604A9E06","file_id":"17377619","error":{"code":"17","message":"Quick quote is not available for this service bureau. Try calling the accurateQuote API."}},{"success":false,"service_bureau_id":"ea0036eb-43da-4495-ae1b-3fff63e92db7","material_id":"6759E5F8-A896-4695-BB11-5B9D604A9E06","file_id":"17377619","error":{"code":"16","message":"This material is not supported by the service bureau."}}]}');

		if(response.success){
			 return response.quotes;
		 }
		else{
			 return null;
		 }*/

	}

	var getCartUrl = function(serviceBureauId, currentFileId){

		//ADSKSpark.Files.getFileDetails(currentFileId).then(function (response) {
			//console.info('getFileDetails file response:', response);
		    //var fileName = response.file_name;
		    var fileName = "file.stl";

			var data = JSON.stringify({ 'models' : [ {'file_id' : currentFileId, 'file_name' : fileName, 'quantity':1} ] });

			ADSKSpark.ServiceBureaus.getCartUrl(serviceBureauId, data).then(function (response) {
				console.info('get cart url response:', response);
				if(response.urls != undefined && response.urls.length > 0){
					$(".spinner").hide();
					var url = response.urls[0].url;
					parent.window.open(url);
				}
			});
		//});





	}

	var initialize = function(){
    	getServiceBureaus();
		getSparkMaterials();
	}

	var getServiceBureauLogoUrlById = function(id){
		var logoUrl = "";
		for(var i in serviceBureaus){
			if(serviceBureaus[i].id == id){
				logoUrl = serviceBureaus[i].logoUrl;
				break;
			}
		}
		return logoUrl;
	}


	$(document).ready(function(){
		//log http requests
		ajaxCallListenerFromIframe();

		$("#materials-select").on("change", function(e){

			var materialId = $('#materials-select option:selected').val();
			if(materialId != "") {
				getQuotes(materialId, currentFileId);
			}
		});

		$('#quotes-container').on('click', 'a.print_btn', function(e) {
			e.preventDefault();
			var serviceBureauId = $(this).attr("data-service-bureau-id");
			if(serviceBureauId != "") {
				$(this).parents(".quote").find(".spinner").show();
				getCartUrl(serviceBureauId, currentFileId);
			}
		});

	});

	/**
	 * Run when DOM is ready.
	 * The spark object already exists in this point
	 */
	jQuery(function ($) {

		//First let's see if we have a valid access token
		if (!ADSKSpark.Client.isAccessTokenValid()) {
			location.href = '../../../plugins/login/login.html';
		} else {
			//Assume we provided assetId in URL
			var urlParams = ADSKSpark.Helpers.extractParamsFromURL();
			currentFileId = urlParams['fileId'] ? urlParams['fileId'] : 0;

			ADSKSpark.Files.getFileDetails(currentFileId).then(function (response) {
				console.info('getFileDetails file response:', response);
				//var fileName = response.file_name;
			});

			if (!currentFileId) {
				location.href = '../service-bureaus/upload.html';
			} else {

				common.setUIFunctionality();
				initialize();
			}
		}

		//broadcast the state to the iframe - intended only for the storage UI
		eventBroadCaster.broadcastEvent('getQuotes',{fileId:currentFileId});
	});
</script>
<script src="three.min.js"></script>

<script src="STLLoader.js"></script>

<script>

	var container, camera, scene, renderer;

	init();
	animate();

	function init() {

		container = document.createElement( 'div' );
		$("#canvas-container").append( container );

		// renderer

		renderer = new THREE.WebGLRenderer( { antialias: true } );
		renderer.setSize( window.innerWidth, window.innerHeight );
		container.appendChild( renderer.domElement );

		// scene

		scene = new THREE.Scene();

		// camera

		camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 10000 );
		camera.position.set( 3, 0.5, 3 );
		scene.add( camera ); // required, because we are adding a light as a child of the camera

		// lights

		scene.add( new THREE.AmbientLight( 0x222222 ) );

		var light = new THREE.PointLight( 0xffffff, 0.8 );
		camera.add( light );

		// object

		var loader = new THREE.STLLoader();
		loader.load( 'pokball.stl', function ( geometry ) {

			var material = new THREE.MeshPhongMaterial( { color: 0xff5533 } );

			var mesh = new THREE.Mesh( geometry, material );

			scene.add( mesh );

		} );

		window.addEventListener( 'resize', onWindowResize, false );

	}

	function onWindowResize() {

		camera.aspect = window.innerWidth / window.innerHeight;

		camera.updateProjectionMatrix();

		renderer.setSize( window.innerWidth, window.innerHeight );

	}

	function animate() {

		requestAnimationFrame( animate );

		render();

	}

	function render() {

		var timer = Date.now() * 0.0005;

		camera.position.x = Math.cos( timer ) * 5;
		camera.position.z = Math.sin( timer ) * 5;

		camera.lookAt( scene.position );

		renderer.render( scene, camera );

	}
	</script>

</body>
</html>